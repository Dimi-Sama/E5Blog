<!-- 
⣿⣿⣿⡇⠄⣠⣬⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⡝⠙⣿⣷⡄⣹⣿⣿⣿⣿⠛⠛⠛⠛⠋⠛⠛⠛⠛⠛⠛⠛⠛⠛⠛⠛⠛⠛⠛⠿⠿⠿⠿⠿⠿⠿⠿⠿⠿⠟⠿⡿⠿⠿⠿⠿⠿⠿⠿⢛⡻⡿⠿⣿⣿⣿⣿⣿⣿⣿
⣄⠄⡼⣿⣷⣿⣿⣿⡉⣿⣿⣿⣿⣿⡟⢿⣿⠄⠄⠄⠄⠘⣿⣿⣿⣿⡟⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⣿⣿⣿⣿⣿⣿⣿
⠄⢱⡓⠉⠙⠙⠛⣻⠃⣿⣿⣿⣿⣿⠇⠸⣿⠄⠄⠄⠄⠄⠸⣿⡻⣿⣿⡘⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⢿⣿⡟⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⣿⣿⠟⡿⠿⣿⣿
⡠⠞⢯⣤⣠⣤⣾⣷⠄⣿⣿⣿⣿⣿⠄⠄⢻⠄⠄⠄⠄⠄⠄⠘⢧⠙⠻⣿⣄⠻⣿⣿⣿⣿⡟⣿⣿⣿⣿⠈⢿⣧⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⣷⠋⡾⣇⣀⣸⣿
⣿⡿⣿⣿⢏⡿⠉⠉⠄⣿⣿⣿⣿⣿⠄⠄⠘⠒⠒⠒⠒⠒⠶⠶⠤⠄⠄⠈⠙⠂⠈⠙⠛⠋⠉⠉⠭⠿⠿⠶⠾⠛⠚⠛⠛⠛⠋⣿⣿⣿⣿⣿⡇⣿⣿⣿⣿⣿⣿⣿
⠿⡀⠄⠘⠉⠇⠂⠄⠄⣇⢻⣿⣿⣯⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⣿⣿⣿⣿⣿⡇⣿⣿⣿⣿⣿⣿⣿
⡆⠁⠄⠊⠙⠒⢄⣀⠄⣿⠐⢿⣿⣿⢠⣶⣦⣤⣀⣀⣀⣀⣀⣀⣀⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⢀⣀⣀⣀⠄⢀⣀⣀⣤⣤⣤⣿⣿⡯⢿⣿⡇⣿⣿⣿⣿⣿⣿⣿
⠄⠄⠄⣀⡀⠄⢈⣿⡆⣻⡇⠄⠛⣿⡆⠄⠉⠉⠙⠛⠛⠋⠉⠁⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠈⠉⠙⠛⠛⠛⠋⠉⠒⢰⣿⣿⡇⠘⣿⡇⣿⣿⣿⣿⣿⣿⣿
⣀⢠⠄⠁⠲⣻⣿⠿⠃⣿⣿⡀⠄⠘⢿⡀⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⢸⣿⣿⢀⣴⣿⡇⣿⣿⣿⣿⣿⣿⣿
⣿⣷⣀⠄⣀⢟⡩⣲⠄⣿⣿⣿⣤⣀⠈⠻⣄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⣼⣿⣿⣿⣿⣿⡇⣹⣿⣿⣿⣿⣿⣿
⣵⣝⢿⣟⡯⠭⡹⣿⣄⣿⣿⣿⣿⣿⣷⡀⠈⠳⢄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⢀⣿⣿⣿⣿⣿⣿⡇⢮⣭⡯⠍⠹⣻⣿
⣿⣿⣿⣿⡛⣫⣴⣿⠌⢹⢿⣿⣿⣿⣿⣿⡄⠄⠄⠈⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⢀⣾⣿⣿⣿⣿⣿⣿⡇⣚⠗⠄⠄⣰⣿⣿
⡟⠏⠉⠉⠻⣦⡉⢩⠤⠈⠉⠄⣩⡿⠛⠛⠛⠂⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠛⠛⠛⠛⠛⣛⣛⣛⣃⣿⣷⣶⣿⣿⣿⣿
⣩⠅⠄⠄⢺⠿⠛⢦⣇⢠⠈⣨⣾⣷⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⣀⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⣿⣿⣿⣿⣿⣿⣿⣿⣿⣯⣥⣤
⣣⣴⣇⢸⠟⣄⣀⣸⣿⣿⣿⣿⣿⣯⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠺⣿⣦⣄⣀⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⢠⣶⣶⢿⣿⣿⣿⣟⣿⢿⣿⣿⣿⣿⣿⣿ 
-->
<?php
session_start();
//Connects to the database and retrieves the article with the given ID.
include 'lib/dbConnect.php';
$bd = new DbConnect();
$conn = $bd->connect();

$idArt = $_GET['idArticle'];

$sql = "SELECT * FROM article WHERE id= :id";
$req = $conn->prepare($sql);
$req->bindParam(':id', $idArt);
$req->execute();
$art = $req->fetch(PDO::FETCH_ASSOC);
?>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" href="styles/articlesView.css">
    <link rel="stylesheet" href="styles/main.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?php echo $art['titre'] ?></title>
</head>

<body>
    <div class="background">
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>

        <?php require_once "lib/navbar.php" ?>
        <div class="containerArticle">
            <div>
                <h1 class="titreArticle"><?php echo $art['titre'] ?></h1>
                <img class="viewArticle" src="images/<?php echo $art['image'] ?>" alt="Image" class="image">
                <p class="textArticle"><?php $date = new DateTime($art['datePublication']);
                                        $formatter = new IntlDateFormatter('fr_FR', IntlDateFormatter::FULL, IntlDateFormatter::NONE);
                                        echo "Publié le " . $formatter->format($date);  ?></p>
                <?php


                //This code block checks if a user is logged in and displays a like button accordingly. 
                //If the user is not logged in, the like button is displayed with a link to the login page. 
                //If the user is logged in, the code fetches the list of users who have liked the article and checks if the current user has already liked the article. 


                if (!isset($_SESSION['User'])) {
                    echo " <div class='likes'><a  href='login-form.php'><img height='15px' src='https://cdn-icons-png.flaticon.com/512/1077/1077035.png' style='filter:invert(1);'><p>  " . $art['likeTotal'] . "</p></a> </div>";
                } else {

                    $sql = "SELECT idUser FROM likes WHERE idArticle = :idArt";
                    // Pour éviter les injections SQL
                    $result = $conn->prepare($sql);
                    $result->bindParam(':idArt', $idArt);
                    $result->execute();
                    $users = $result->fetchAll(PDO::FETCH_ASSOC);
                    $like = FALSE;
                    foreach ($users as $user) {
                        if ($user['idUser'] == $_SESSION["User"]) {
                            $like = 'TRUE';
                        }
                    }
                    //If the user has already liked the article, the like button is displayed with a link to unlike the article. 
                    //If the user has not liked the article, the like button is displayed with a link to like the article.
                    if ($like == 'TRUE') {
                        echo " <div class='likes'> <a href='like.php?like=TRUE&idUser=" . $_SESSION["User"] . "&idArt=" . $idArt . "'><img height='15px' src='https://cdn-icons-png.flaticon.com/512/2107/2107845.png'><p>  " . $art['likeTotal'] . "</p></a> </div>";
                    } else {
                        echo " <div class='likes'><a  href='like.php?idUser=" . $_SESSION["User"] . "&idArt=" . $idArt . "'><img height='15px' src='https://cdn-icons-png.flaticon.com/512/1077/1077035.png' style='filter:invert(1);'><p>  " . $art['likeTotal'] . "</p></a> </div>";
                    }
                }

                ?>
                <?php echo $art['contenu'] ?>
                <?php if (isset($_SESSION['Modo'])) {
                    echo '<div class="boutart"><a  href="updatePost.php?idArticle=' . $idArt . '">Modifier l\'article</a> ';
                    echo '<a class="boutart" href="deletePost.php?idArticle=' . $idArt . '">Supprimer l\'article</a></div>';
                } ?>
            </div>
        </div>
        <div class="containerArticle">
            <h1>Commentaires</h1>
            <form action="scriptComment.php?idArt=<?php echo $idArt ?>" method="POST">
                <?php
                // Vérifier si l'utilisateur est connecté
                if (isset($_SESSION['User'])) {
                    echo '<textarea name="commentaire" placeholder="Saisissez votre commentaire ici"></textarea>';
                    echo '<input type="submit" value="Ajouter un commentaire">';
                } else {
                    echo '<p>Veuillez vous connecter pour commenter.</p>';
                }
                ?>
            </form>

            <?php
            $sql = "SELECT commentaires.*, username FROM commentaires
                    INNER JOIN utilisateurs ON commentaires.idUser = utilisateurs.id
                    WHERE idArticle = :idArt";
            $req = $conn->prepare($sql);
            $req->bindParam(':idArt', $idArt);
            $req->execute();
            $commentaires = $req->fetchAll(PDO::FETCH_ASSOC);

            foreach ($commentaires as $commentaire) {
                echo '<div class="commentaire">';
                echo '<h5>' . $commentaire['username'] . '</h5>';
                echo '<p>' . $commentaire['texte'] . '</p>';
                echo '</div>';
            }
            ?>

        </div>
    </div>
    </div>
</body>

</html>